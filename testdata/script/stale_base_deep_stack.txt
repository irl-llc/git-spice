# Stale base is detected in the middle of a deep stack.

as 'Test <test@example.com>'
at '2024-04-05T16:40:32Z'

# setup
cd repo
git init
git commit --allow-empty -m 'Initial commit'

# set up a fake GitHub remote
shamhub init
shamhub new origin alice/example.git
shamhub register alice
git push origin main

env SHAMHUB_USERNAME=alice
gs auth login

# create a deep stack: main -> feat1 -> feat2 -> feat3
git add feature1.txt
gs bc feature1 -m 'Add feature 1'
git add feature2.txt
gs bc feature2 -m 'Add feature 2'
git add feature3.txt
gs bc feature3 -m 'Add feature 3'

# submit the full stack
gs downstack submit --fill
stderr 'Created #1'
stderr 'Created #2'
stderr 'Created #3'

# merge feature1 externally (middle of the stack)
shamhub merge alice/example 1

# from feat3, stack submit should detect feat1 as stale
# even though feat3's immediate base is feat2
! gs ss --fill
stderr 'stale base feature1'
stderr 'gs repo sync'
stderr 'no-branch-check'

# branch merge from feat3 should also detect the stale base
! gs bm
stderr 'stale base feature1'
stderr 'gs repo sync'
stderr 'no-branch-check'

# --no-branch-check bypasses the stale base check for submit
gs ss --fill --no-branch-check
stderr '#3 is up-to-date'

-- repo/feature1.txt --
This is feature 1
-- repo/feature2.txt --
This is feature 2
-- repo/feature3.txt --
This is feature 3
