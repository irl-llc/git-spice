# 'ci merge-guard' blocks at every non-trunk level of a deep stack.

as 'Test <test@example.com>'
at '2024-04-05T16:40:32Z'

# setup
cd repo
git init
git commit --allow-empty -m 'Initial commit'

# set up a fake GitHub remote
shamhub init
shamhub new origin alice/example.git
shamhub register alice
git push origin main

env SHAMHUB_USERNAME=alice
gs auth login

# create a deep stack: main -> feat1 -> feat2 -> feat3
git add feature1.txt
gs bc feature1 -m 'Add feature 1'
git add feature2.txt
gs bc feature2 -m 'Add feature 2'
git add feature3.txt
gs bc feature3 -m 'Add feature 3'

# submit the full stack
gs downstack submit --fill
stderr 'Created #1'
stderr 'Created #2'
stderr 'Created #3'

# PR #1 based on main — safe
gs ci merge-guard 1
stderr 'safe to merge'

# PR #2 based on feature1, not trunk — blocked
! gs ci merge-guard 2
stderr 'base is "feature1"'
stderr 'expected trunk "main"'

# PR #3 based on feature2, not trunk — blocked
! gs ci merge-guard 3
stderr 'base is "feature2"'
stderr 'expected trunk "main"'

-- repo/feature1.txt --
This is feature 1
-- repo/feature2.txt --
This is feature 2
-- repo/feature3.txt --
This is feature 3
